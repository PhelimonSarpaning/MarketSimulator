extends index.pug

block content
	link(href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/css/select2.min.css" rel="stylesheet")

	.container
		br
		h2 #{portfolio.name}
		//- Round availableCapital to nearest two decimal places
		- var factor = Math.pow(10, 2);
		- var availableCapital = portfolio.availableCapital
		h4 Available Capital: #{Math.round(availableCapital * factor) / factor}
		p.lead #{portfolio.description}
		ul.nav.nav-tabs(role='tablist')
			li.nav-item.mr-2
				a.nav-link(data-toggle="tab" href="#overview" role="tab") Portfolio Overview
			li.nav-item.mr-auto
				a.nav-link(data-toggle="tab" href="#marketplace" role="tab") Marketplace
			li.nav-item
				a.nav-link(data-toggle="tab" href="#settings" role="tab") Settings
		br
		//- Tab contents go here
		.tab-content
			#overview.tab-pane.show.active(role='tabpanel')
				include includes/new-section-modal.pug
				include includes/buy-more-shares.pug

				.d-flex.flex-row.align-items-center
					h2.mr-4 Investments
					button.btn.btn-success(data-toggle='modal' data-target='#new-section-modal')
						span.fas.fa-plus.fa-lg
				br
				if !portfolio.sections || portfolio.sections.length === 0
					.alert.alert-error It appears this portfolio doesn't have any sections, make a new one to get started!
				else
					
					//- sectionId is used to keep track of the section index
					- var sectionId = 0
					each section in portfolio.sections
						.row.d-flex.flex-column
							.card
								.card-header.d-inline-flex.flex-row
									h4.card-title.mr-auto #{section.name}
									a.btn.btn-info(href='/stocks/view-portfolio/' + portfolio.portfolio_id) Manage
								.card-block.p-4
									h5.card-subtitle.mb-2 Holdings
									if !section.holdings || section.holdings.length === 0
										.alert.alert-error It appears this section doesn't have any holdings, head over to the Marketplace to purchase some stocks!
									else
										table.table.table-striped
											thead
												tr
													th(scope='column') Shares
													th(scope='column') Ticker
													th(scope='column') Purchase Price
													th(scope='column') Latest Price
													th(scope='column') % Gain
													th(scope='column') Absolute Gain
													th(scope='column') Actions
											tbody
												each stock in section.holdings
													tr
														td #{stock.shares}
														td #{stock.ticker}
														td #{stock.purchasePrice}
														td.last-price(ticker=stock.ticker) #{stock.lastPrice}
														td --
														td --
														td
															.dropdown.show
																button.btn.dropdown-toggle(style="background-color: lightgray;" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false")
																
																.dropdown-menu.dropdown-menu-right(style="padding: 0; padding-top: 0.1em;" aria-labelledby="dropdownMenuLink")
																	button.dropdown-item.buy-more-modal-toggler(data-toggle='modal' 
																		data-target='#buy-more-shares-modal' data-stock=stock.ticker data-section=sectionId) Buy More
																	
																	button.dropdown-item.performance-checker(ticker=stock.ticker) Stock Performance
																	
																	form.form(method="POST" action="/stocks/sell-all/")
																		input(type="hidden" id="portId" name="portId" value=portfolio.portfolio_id)
																		input(type="hidden" id="sectionId" name="sectionId" value=sectionId)
																		input(type="hidden" id="stockTicker" name="stockTicker" value=stock.ticker)
																		button.dropdown-item.bg-danger.text-white(type="submit") Sell All
						- sectionId++

						br
			#marketplace.tab-pane(role='tabpanel')
				ul.nav.nav-pills.justify-content-center
					li.nav-item.active.mr-3
						a.nav-link(data-toggle="pill" href="#basic-search" role="tab") Basic Search
					li.nav-item.mr-3
						a.nav-link(data-toggle="pill" href="#advanced-search" role="tab") Advanced Search

				br
				.tab-content.d-flex.justify-content-center
					#basic-search.tab-pane(role='tabpanel')
						.row.mb-4
							.col-md-6
								select.select-stock.form-control( style='width: 50em;')
						.row
							.col-md-12.card-container(style='width=30em;')

					#advanced-search.tab-pane(role='tabpanel')
						p.lead (Coming Soon)
			#settings.tab-pane(role='tabpanel')
				include includes/edit-description-modal.pug
				include includes/edit-name-modal.pug
				include includes/restart-game.pug
				include includes/delete-game.pug

				h2 Settings
				br
				
				.col-sm-3.d-flex.flex-row.align-items-center
					h4.mr-auto.ml-0 Name:
					button.btn.btn-primary.btn-sm.mb-2(data-toggle='modal' data-target='#edit-name') Edit
				p.lead &nbsp;&nbsp;&nbsp;&nbsp;#{portfolio.name}
				
				.col-sm-3.d-flex.flex-row.align-items-center
					h4.mr-auto.ml-0 Description:
					button.btn.btn-primary.btn-sm.mb-2(data-toggle='modal' data-target='#edit-description') Edit
				p.lead &nbsp;&nbsp;&nbsp;&nbsp;#{portfolio.description}
				hr
				br
				br

				h2 DANGER ZONE
				br
				button.btn.btn-warning.mb-2(data-toggle='modal' data-target='#restart-game') Restart Game
				br
				button.btn.btn-danger(data-toggle='modal' data-target='#delete-game') Delete Game


block javascript
	include includes/update.pug
	
	script(src='/bower_components/select2/dist/js/select2.min.js')
	script(src='/bower_components/jquery-validation/dist/jquery.validate.min.js')
	script(src='/js/settings.js')
	script(src='/js/stockPerformance.js')
	
	
	script.
		var portfolio_sections = null;
		var sectionSelector = $('#buy-more-shares-modal select[name="selectSection"]');
		var tickerSelector = $('#buy-more-shares-modal select[name="selectTicker"]');
		var stockPriceLabel = $('#buy-more-shares-modal label[name="stock-price"]');
		var maxSharesLabel = $('#buy-more-shares-modal label[name="max-shares"');
		var numSharesInput = $('#buy-more-shares-modal input[name="numShares"]');
		var buyMoreToggler = $('.buy-more-modal-toggler');
	
		$(document).ready(function() {
			// Update the available tickers
			sectionSelector.on('change', function() {
				var sectionId = $(this).val();
				if(portfolio_sections == null)
					portfolio_sections = !{JSON.stringify(portfolio.sections)}
				var section = portfolio_sections[sectionId]

				tickerSelector.empty();
				var stocks = [];
				for(var i = 0; i < section.holdings.length; i++) {
					var ticker = section.holdings[i].ticker
					stocks.push(ticker);
					tickerSelector.append(
						$('<option></option>')
						.attr('value', ticker)
						.text(ticker) )
				}
				
				tickerSelector.trigger('change');
			});
			
			tickerSelector.on('change', function() {
				if(portfolio_sections == null)
					portfolio_sections = !{JSON.stringify(portfolio.sections)}
					
				var ticker = $(this).val()
				var url = 'https://api.iextrading.com/1.0/stock/' + ticker + '/quote';
				$.ajax({
					url: url,
					method: 'get'
				}).done(function(data) {
					var maxStocks = Math.trunc('#{portfolio.availableCapital}' / data.latestPrice);
					console.log(maxStocks);
					
					stockPriceLabel.text(data.latestPrice);
					maxSharesLabel.text(maxStocks);
					numSharesInput.attr('max', maxStocks);
				});
			});
			
			// Set up the information for the first stock
			sectionSelector.trigger('change');
			tickerSelector.trigger('change');
			
			//Create a listener for the 'Buy More' buttons to update the modal selections
			buyMoreToggler.on('click', function() {
				var section = $(this).attr('data-section');
				var ticker = $(this).attr('data-stock');
				console.log(section);
				console.log(ticker);
				
				sectionSelector.val(section);
				sectionSelector.trigger('change');
				tickerSelector.val(ticker).change();
				tickerSelector.trigger('change');
			});
		});
	
	script.
		function sanitize(data) {
			return (!data) ? 'N/A' : data;
		}

		function zoomChart(chart) {
		    chart.zoomToIndexes(chart.dataProvider.length-30, chart.dataProvider.length - 1);
		}

		$(document).ready(function() {
			
			//Set the options of the ticker selector after the page has loaded
			//to significantly reduce load time
			$(document).ready(function() {
				var stockSelector = $('.select-stock');
				var available = !{JSON.stringify(availableStocks)}
				stockSelector.html(available);
			});

			$('.select-stock').on('change', function() {
				var ticker = this.value;
				var port_id = '#{portfolio.portfolio_id}';
				var portfolio_sections = !{JSON.stringify(portfolio.sections)}
				var sectionOptions = '';
				for(var i = 0; i < portfolio_sections.length; i++) {
					var sectionName = portfolio_sections[i].name;
					sectionOptions += "<option name='"+ sectionName +"' value=" + i + ">" + sectionName + "</option>";
				}

				$.ajax({
					url: '/indiv-stock/stock-card/' + ticker,
					method: 'GET'
				}).done(function(data) {
					console.log(data);
					var quote = data.quote;
					var company = data.company;
					var stats = data.stats;
					var chartData = data.chart;

					var maxStocks = Math.trunc('#{portfolio.availableCapital}' / quote.latestPrice);

					var date = new Date();
					date = date.getHours() + ':' + date.getMinutes() + ':' + date.getSeconds();

					var buyModal = `
						<div id='buy-modal' class='modal fade' role="dialog">
							<div class='modal-dialog' role='document'>
								<div class='modal-content'>
									<div class='modal-header'>
										<h5 class='modal-title'>Purchase Stock</h5>
										<button type='button' class='close' data-dismiss='modal'></button>
									</div>
									<div class='modal-body'>
										<form method='POST' action='/stocks/purchase-stock/`+port_id+`/`+ticker+`' >
											<div class='form-group'>
												<label name='ticker' class='lead'>Ticker: `+ quote.symbol +`</label>
												<label class='lead'>The price of each share, as of `+ date +` is `+ quote.latestPrice +`</label>
											</div>
											<div class='form-group'>
												<label class='lead'>Section Name</label>
												<select id='addSection' class='form-control' name='addSection'>
													`+ sectionOptions +`
												</select>
												<br>
												<label class='lead'>Number of Shares:</label>
												<input class='form-control' name='numShares' type='number' placeholder='10' min=1 max=`+ maxStocks +`>
											</div>
											<hr>
											<div class='d-flex flex-row-reverse'>
												<input type="submit" class="btn btn-success" value='Make Purchase'>
												<button type="button" class="btn btn-secondary mr-3" data-dismiss="modal"> 	Cancel
												</button>
											</div>
										</form>
									</div>
								</div>
							</div>
						</div>`;

					var stockCard = `
						<div class='card'>
							<div class='card-header'>
								<div class='d-flex flex-row align-items-center'>
									<h2 class='card-title mr-auto'>`+ quote.symbol +`</h3>
									<button class='btn btn-success' data-toggle='modal' data-target='#buy-modal'>
										<span class='fas fa-plus fa-lg'></span>
									</button>
								</div>
							</div>
							<div class='card-block p-4'
								<p class='lead text-muted'>`+ company.companyName +`</p>
								<div id='chartdiv' style='height: 40em; width: 45em;'></div>
								<p class='lead text-muted'>Stock Data</p>
								<table class='table table-striped'>
									<tbody>
										<tr>
											<th>Open</th>
											<td>`+ quote.open +`</td>
											<th>Market Cap</th>
											<td>`+ stats.marketcap +`</td>
											<th>52 Week High</th>
											<td>`+ quote.week52High +`</td>
										</tr>
										<tr>
											<th>Close</th>
											<td>`+ quote.close +`</td>
											<th>P/E Ratio</th>
											<td>`+ sanitize(quote.peRatio) +`</td>
											<th>52 Week Low</th>
											<td>`+ quote.week52Low +`</td>
										</tr>
										<tr>
											<th>High</th>
											<td>`+ quote.high +`</td>
											<th>Dividend Yield</th>
											<td>`+ stats.dividendYield +`</td>
											<th></th>
											<td></td>
										</tr>
									</tbody>
								</table>
								<a class='btn btn-info' data-toggle="collapse" href="#company-info" role="button">More Info</a>

								<div class='card-body collapse' id='company-info' style='width: 40em;'>
									<p class='lead'>CEO: `+ company.CEO +`</p>
									<p class='lead'>Industry: `+ company.industry +`</p>
									<p class='lead'>Sector: `+ company.sector +`</p>
									<p class='lead'>Description: `+ company.description +`</p>
									<p class='lead'>Exchange: `+ company.exchange +`</p>
								</div>
							</div>
						</div>
					`

					$('.card-container').html(buyModal + stockCard);

					var chart = AmCharts.makeChart("chartdiv", {
						"type": "serial",
					    "theme": "light",
					    "marginRight": 40,
					    "marginLeft": 40,
					    "autoMarginOffset": 20,
					    "mouseWheelZoomEnabled":true,
					    "dataDateFormat": "YYYY-MM-DD",
					    "valueAxes": [{
					        "id": "v1",
					        "axisAlpha": 0,
					        "position": "left",
					        "ignoreAxisWidth":true
					    }],
					    "balloon": {
					        "borderThickness": 1,
					        "shadowAlpha": 0
					    },
					    "graphs": [{
					        "id": "g1",
					        "balloon":{
					          "drop":true,
					          "adjustBorderColor":false,
					          "color":"#ffffff"
					        },
					        "bullet": "round",
					        "bulletBorderAlpha": 1,
					        "bulletColor": "#FFFFFF",
					        "bulletSize": 5,
					        "hideBulletsCount": 50,
					        "lineThickness": 2,
							"lineColor": "#98FB98",
							"useNegativeColorIfDown": true,
							"negativeLineColor": "#FA8072",
					        "title": "red line",
					        "useLineColorForBulletBorder": true,
					        "valueField": "value",
					        "balloonText": "<span style='font-size:18px;'>[[value]]</span>"
					    }],
					    "chartScrollbar": {
					        "graph": "g1",
					        "oppositeAxis":false,
					        "offset":30,
					        "scrollbarHeight": 80,
					        "backgroundAlpha": 0,
					        "selectedBackgroundAlpha": 0.1,
					        "selectedBackgroundColor": "#888888",
					        "graphFillAlpha": 0,
					        "graphLineAlpha": 0.5,
					        "selectedGraphFillAlpha": 0,
					        "selectedGraphLineAlpha": 1,
					        "autoGridCount":true,
					        "color":"#AAAAAA"
					    },
					    "chartCursor": {
					        "pan": true,
					        "valueLineEnabled": true,
					        "valueLineBalloonEnabled": true,
					        "cursorAlpha":1,
					        "cursorColor":"#258cbb",
					        "limitToGraph":"g1",
					        "valueLineAlpha":0.2,
					        "valueZoomable":true
					    },
					    "valueScrollbar":{
					      "oppositeAxis":false,
					      "offset":50,
					      "scrollbarHeight":10
					    },
					    "categoryField": "date",
					    "categoryAxis": {
					        "parseDates": true,
					        "dashLength": 1,
					        "minorGridEnabled": true
					    },
					    "export": {
					        "enabled": false
					    },
					    "dataProvider": chartData
					});

					chart.addListener("rendered", zoomChart);

					zoomChart(chart);
				});
			})
		})
